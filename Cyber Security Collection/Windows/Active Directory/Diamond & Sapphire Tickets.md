> [!important]  
> –ê—Ç–∞–∫–∏ Diamond & Sapphire Ticket –ø–æ–∑–≤–æ–ª—è—é—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫—É –∏–∑–º–µ–Ω—è—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–µ–≥–∏—Ç–∏–º–Ω–æ –≤—ã–¥–∞–Ω–Ω—ã–π TGT –±–∏–ª–µ—Ç. –í —Å–ª—É—á–∞–µ —Å Diamond ticket, –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π PAC –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞. –î–ª—è Sapphire ticket, –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π PAC –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ PAC, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å –ø–æ–º–æ—â—å—é S4U2self+u2u. –î–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ —è–≤–ª—è—é—Ç—Å—è —Å–∫—Ä—ã—Ç–Ω—ã–º–∏ –∏ —Ç—è–∂–µ–ª—ã–º–∏ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è.
> 

# –¢–µ–æ—Ä–∏—è

–ü—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ —Å—Ç–æ–∏—Ç—å –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –æ–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –∞—Ç–∞–∫ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ PAC –ª–µ–≥–∏—Ç–∏–º–Ω–æ –≤—ã–¥–∞–Ω–Ω–æ–≥–æ TGT –±–∏–ª–µ—Ç–∞. 

*PAC (Privilege Attribute Certificate) ‚Äî —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥—Ä—É–ø–ø—ã, –≤ –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞) –∏ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é TGT/TGS –±–∏–ª–µ—Ç–æ–≤.*

–î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–∏–µ–º Kerberos (–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–µ PAC) –≤ –±–∏–ª–µ—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –º–Ω–æ–≥–∏–µ —Å–ª—É–∂–±—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç PAC, –Ω–µ —É–±–µ–∂–¥–∞—è—Å—å –≤ –µ–≥–æ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ (–¥–∞–∂–µ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ KDC).

### –†–∞–±–æ—Ç–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ PAC
**AS-REQ –∏ AS-REP:**
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç¬†**AS-REQ**¬†–≤ –¶–µ–Ω—Ç—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π (KDC), —á—Ç–æ–±—ã –∑–∞–ø—Ä–æ—Å–∏—Ç—å –±–∏–ª–µ—Ç –¥–ª—è –≤—ã–¥–∞—á–∏ –±–∏–ª–µ—Ç–∞ (TGT).
- KDC –≤—ã–¥–∞—ë—Ç TGT –≤¬†**AS-REP**, –≤—Å—Ç—Ä–∞–∏–≤–∞—è PAC –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —á–∞—Å—Ç—å –±–∏–ª–µ—Ç–∞.

**TGS-REQ –∏ TGS-REP:**
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç¬†**TGS-REQ –≤ KDC**, –∏—Å–ø–æ–ª—å–∑—É—è TGT –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.
- KDC –æ—Ç–≤–µ—á–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é¬†**TGS-REP**, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç PAC.

**AP-REQ:**
- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç¬†**TGS**¬†(–≤–∫–ª—é—á–∞—è PAC) —Ü–µ–ª–µ–≤–æ–º—É —Å–µ—Ä–≤–∏—Å—É.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ PAC —Å–ª—É–∂–±–æ–π:**
- –ï—Å–ª–∏ —Å–ª—É–∂–±–∞ –¥–æ–≤–µ—Ä—è–µ—Ç KDC, –æ–Ω–∞ –º–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PAC –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏.
- –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å—É —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PAC, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PAC –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ–º–µ–Ω–∞ (DC) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–°–≤–µ–¥–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ PAC:**
- –°–ª—É–∂–±–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PAC –≤ DC —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ Kerberos.
- DC –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å PAC (—Å–æ–∑–¥–∞–Ω–Ω—É—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞ KDC) –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏.
- –ï—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–∞–∫, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–ª—É–∂–±–µ.

**AP-REP:**
- –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ PAC —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç –≤ –¥–æ—Å—Ç—É–ø–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–∞–∂–¥—É—é –∞—Ç–∞–∫—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ.
## Diamond Ticket
–ü–æ —Å–≤–æ–µ–π —Å—É—Ç–∏, Diamond Ticket ‚Äî —ç—Ç–æ TGT, –∫–æ—Ç–æ—Ä—ã–π:
1. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é —Å–µ–∫—Ä–µ—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt.
2. –ü–æ–¥–≤–µ—Ä–≥–Ω—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ PAC (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –ø—É—Ç–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –≥—Ä—É–ø–ø—É "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –¥–æ–º–µ–Ω–∞").
3. –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é —Å–µ–∫—Ä–µ—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt.

–ü–æ—Å–∫–æ–ª—å–∫—É PAC —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–ª—É—á–µ–Ω–∏—è TGT, —Ç–æ –∑–∞ TGS –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å –Ω–µ —Å—Ç–æ–∏—Ç: –æ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç PAC –Ω–∞–ø—Ä—è–º—É—é, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –∏–∑ TGT, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –ø—Ä–∞–≤–∞. 

–û–¥–Ω–∞–∫–æ, —Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –µ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ –Ω–µ–ª–∞–¥–Ω–æ–≥–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–≤–æ–∏–ª —Å–µ–±–µ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ç–æ–π –∏–ª–∏ –∏–Ω–æ–π –≥—Ä—É–ø–ø–µ, –Ω–∞ –¥–µ–ª–µ —á–ª–µ–Ω–æ–º –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è, —Å–ª—É–∂–±–∞ –∏–ª–∏ KDC –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å PAC –∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –±–∏–ª–µ—Ç –ø–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∏–ª–µ—Ç–µ –∏ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ AD. –í –∞–Ω–∞–ª–æ–≥–∏—é –º–æ–∂–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –º—ã –≤—ã–ø—É—Å–∫–∞–µ–º –±–∏–ª–µ—Ç TGT (–∞—Ç–∞–∫–∞ [Golden Ticket](https://habr.com/ru/articles/836818/)) –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Diamond Ticket:**
1. NT-—Ö—ç—à —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt/—Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.
2. –ö–ª—é—á AES256 —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt/—Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è PAC).
3. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞.
4. SID –¥–æ–º–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
5. –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –£–ó, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –≤—ã–ø—É—Å–∫–∞–µ–º –±–∏–ª–µ—Ç.
6. SPN —Å–ª—É–∂–±—ã, –∫ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø.
## Sapphire Ticket
~~–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –º–µ—á—Ç–∞–ª–∏ —Å—Ç–∞—Ç—å –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–µ–π —Å–µ–±—è? –ú–æ–ª–æ–∂–µ, –∫—Ä–∞—Å–∏–≤–µ–µ, –∏–¥–µ–∞–ª—å–Ω–µ–µ?~~

Sapphire Ticket ‚Äî —ç—Ç–æ —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è Diamond Ticket, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –±–æ–ª–µ–µ —Å–∫—Ä—ã—Ç–Ω–æ–º –∏ "–ª–µ–≥–∏—Ç–∏–º–Ω–æ–º" —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è "–ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –±–∏–ª–µ—Ç–∞" –ø–æ–¥—Ö–æ–¥–µ.

–ö–∞–∫ —è –ø–∏—Å–∞–ª –≤—ã—à–µ, —Å–µ—Ä–≤–∏—Å –∏–ª–∏ KDC –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –±–∏–ª–µ—Ç–µ –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Active Directory –º–æ–≥—É—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è. –ß—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ —ç—Ç–æ—Ç –Ω—é–∞–Ω—Å, –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–Ω–æ–≤–æ —à–∏—Ñ—Ä—É—é—Ç PAC –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏—è–º–∏, –∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏. –≠—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è S4U2self+u2u. –ò–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –æ–±–º–∞–Ω—ã–≤–∞–µ–º —ç—Ç—É –≥—Ä–µ–±–∞–Ω—É—é —Ä–∞–∫–µ—Ç–∫—É.

–ê —Ç–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–∂–∫–æ –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º:

*S4U2self (Service for User to Self) ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ—Ä–≤–∏—Å—É –ø–æ–ª—É—á–∏—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–π –±–∏–ª–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞) –¥–ª—è —Å–µ–±—è.*
*u2u (user to user) ‚Äî —ç—Ç–æ —Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å –æ–±—ã—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–∞–∑–º–µ—â–∞—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ —Å–≤–æ–∏—Ö —Ö–æ—Å—Ç–∞—Ö. –í –ø—Ä–æ—Ç–æ–∫–æ–ª–µ ¬´–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å¬ª –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞, –∞ –¥—Ä—É–≥–æ–π ‚Äî –≤ —Ä–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞.*

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ S4U2self –∏ u2u –≤–º–µ—Å—Ç–µ, —Ñ–ª–∞–≥–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–∫–ª—é—á–∞—é—Ç –≤ —Å–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã, –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è. –ù–æ –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞—Ç–∞–∫–∏?

**–û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –∞—Ç–∞–∫–∏:**
1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∏–ª–µ—Ç S4U2Self —Å –ø–æ–º–æ—â—å—é u2u –±–µ–∑ SPN –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω–∞).
2. –ü–æ–ª—É—á–∞–µ–º ST (–∫–∞–∫ –µ—Å–ª–∏ –±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –Ω–∞–º).
3. –ò–∑ –ø.2 –∏–º–µ–µ–º PAC.
4. –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º PAC —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–µ–π krbtgt.
5. –ò–∑–º–µ–Ω—è–µ–º PAC –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ TGT.
6. –®–∏—Ñ—Ä—É–µ–º PAC —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–µ–π krbtgt.
7. –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∏–ª–µ—Ç.

[–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ S4U2self –∏ u2u ](https://www.thehacker.recipes/ad/movement/kerberos/#s4u2self-+-u2u)

**–î–ª—è Sapphire Ticket –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:**
1. NT-—Ö—ç—à —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt/—Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.
2. –ö–ª—é—á AES256 —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ krbtgt/—Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (–¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è PAC).
3. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞.
4. SID –¥–æ–º–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
5. –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –£–ó, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –≤—ã–ø—É—Å–∫–∞–µ–º –±–∏–ª–µ—Ç.
6. SPN —Å–ª—É–∂–±—ã, –∫ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø.
7. –ò–º—è –£–ó —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.

# –ü—Ä–∞–∫—Ç–∏–∫–∞
–ê—Ç–∞–∫–∏ –±—É–¥—É –ø—Ä–æ–≤–æ–¥–∏—Ç—å –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ticket_user, —á–ª–µ–Ω—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–º–µ–Ω–∞".
## Diamond Ticket
#### –£–¥–∞–ª–µ–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä
–ü–æ-—Å—Ç–∞—Ä–∏–Ω–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º impacket. –í –Ω–µ–º –µ—Å—Ç—å –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–∞—è —Ç—É–ª–∑–∞ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º ticketer:

``` shell
impacket-ticketer -request -domain 'domain' -user 'user' -password 'password' -nthash 'krbtgt/service nthash' -aesKey 'krbtgt/service aesKey' -domain-sid 'domain-sid'  -groups 'optional' user
```

*–≥–¥–µ `user` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ SPN –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–¥–∞–µ—Ç —Å–µ–±—è –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫, –ø–æ–¥–¥–µ–ª—ã–≤–∞—è –¥–æ—Å—Ç—É–ø aka –¥–ª—è –∫–æ–≥–æ –±—É–¥–µ—Ç –≤—ã–ø—É—â–µ–Ω –±–∏–ª–µ—Ç*.

![](../../../Attachments/dt_2.png)

–í—ã–ø–æ–ª–Ω—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç –±–∏–ª–µ—Ç–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∞—Ç–∞–∫–∏ PassTheTicket:

```shell
export KRB5CCNAME=ticket.ccache
```

![](../../../Attachments/dt_0.png)

–° –ø–æ–º–æ—â—å—é psexec –∏–∑ —Ç–æ–≥–æ –∂–µ –Ω–∞–±–æ—Ä–∞ impacket –ø—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã–ø—É—â–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞:

```shell
impacket-psexec 'domain/user@host.domain' -dc-ip ip -k -no-pass
```

![](../../../Attachments/dt_1.png)

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –Ω–∞–º —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π "–ª–µ–≥–∏—Ç–∏–º–Ω–æ –≤—ã–¥–∞–Ω–Ω—ã–π" KDC –±–∏–ª–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ticket_user –∏ –ø—Ä–∏—Å–≤–æ–∏—Ç—å –µ–º—É —á–ª–µ–Ω—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
#### –õ–æ–∫–∞–ª—å–Ω—ã–π –≤–µ–∫—Ç–æ—Ä
–ê—Ç–∞–∫—É –≤–æ–∑–º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –ø—Ä–æ—ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Rubeus:

``` c
rubeus.exe diamond /krbkey:aesKey /user:user /password:password /enctype:aes /domain:domain /dc:dc-fqdn /ticketuser:user /ptt /nowrap
```


![](../../../Attachments/dt_9.png)
## Sapphire Ticket
–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–ª–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å –ø–æ–º–æ—â—å—é ticketer –∏–∑ –Ω–∞–±–æ—Ä–∞ impacket –≤–µ—Ä—Å–∏–∏ >= 0.10.0.
–û–±—â–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–º–∞–Ω–¥—ã –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥:

```shell
impacket-ticketer -request -impersonate 'admin_acc' -domain 'domain' -user 'user' -password 'password' -nthash 'krbgtg_nthash' -aesKey 'krbtgt-aesKey' -domain-sid 'domain-sid' ticket_name
```

![](../../../Attachments/sst_6.png)

–ú–µ–∂–¥—É —Ç–µ–º, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ç—Ä–∞—Ñ–∏–∫ –æ–±—â–µ–Ω–∏—è —Å KDC –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞. –ù–∞–ø–æ–º–Ω—é, —á—Ç–æ TGT –±–∏–ª–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª—Å—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ticket_user:

![](../../../Attachments/sst_8.png)

AS-REQ –∏ AS-REP –º—ã –ø—Ä–æ–ø—É—Å—Ç–∏–º, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –Ω–∏—Ö –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–π –Ω–∞—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

**TGS-REQ:**

![](../../../Attachments/sst_1.png)

–ó–¥–µ—Å—å —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫ PA-DATA pA-FOR-USER. –≠—Ç–æ –Ω–∏—á—Ç–æ –∏–Ω–æ–µ, –∫–∞–∫ S4U2Self. –ö–∞–∫ –≤–∏–¥–∏–º, –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –≤—ã–ø—É—Å–∫—É –±–∏–ª–µ—Ç–∞ –∏–¥–µ—Ç –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é admin (—ç—Ç–æ –Ω–∞—à impersonate).

![](../../../Attachments/sst_2.png)

–¢–∞–∫–∂–µ –≤–∞–∂–Ω—ã–º —è–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫ req-body, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–º, —á—Ç–æ —ç—Ç–æ u2u, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ª–µ–≥–∏—Ç–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª TGT —É KDC.
–ò—Ç–æ–≥–æ, –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —á—Ç–æ –º—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –±–∏–ª–µ—Ç S4U2Self —Å –ø–æ–º–æ—â—å—é u2u –±–µ–∑ SPN –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –∏, –≤ —Å–ª–µ–¥—Å—Ç–≤–∏–∏, –ø–æ–ª—É—á–∏–ª–∏ ST.

**TGS-REP:**

![](../../../Attachments/sst_3.png)

–û—Ç–≤–µ—Ç –æ—Ç KDC —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ 2 –≤–∞–∂–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –±–æ–∫–∞: cname –∏ ticket. 
cname —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –ª–µ–≥–∏—Ç–∏–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (CnameString), –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å—É (SNameString –≤ –±–ª–æ–∫–µ ticket).

–î–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≤–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤—ã–ø—É—â–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞: 

```shell
python3 --aes 'aes-key' ticket.ccache
```

![](../../../Attachments/sst_9.png)
![](../../../Attachments/sst_10.png)

–•–æ—Ä–æ—à–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –±–∏–ª–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –£–ó admin, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∏–∫–∞–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π –£–ó user_ticket. –≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–º –æ —Ç–æ–º, —á—Ç–æ PAC, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, –±—ã–ª –ø–æ–¥–ø–∏—Å–∞–Ω —Å –ø–æ–º–æ—â—å—é –Ω—É–∂–Ω–æ–π –£–ó.

–ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç:

```shell
export KRB5CCNAME=ticket.ccache

impacket-psexec 'domain/impersonate-user@fqdn' -k -no-pass
```


![](../../../Attachments/sst_7.png)

# –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
–ù–∞–º —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ –æ–±–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ KDC c —Ü–µ–ª—å—é –ø–æ–ª—É—á–µ–Ω–∏—è TGT –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –Ω–∏–º –∏, –∫–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, –∑–∞–ø—Ä–æ—Å–∞ TGS. 
## Diamond Ticket
–ù–æ –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç —Å–æ–±—ã—Ç–∏—è 4768 (–∑–∞–ø—Ä–æ—Å TGT) –∏ 4769 (–ó–∞–ø—Ä–æ—Å TGS) –∏ –º–æ–∂–Ω–æ –ª–∏ –∫–∞–∫-—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –∞—Ç–∞–∫—É –ø–æ –∏—Ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é?

**MSGID 4768:**

![](../../../Attachments/dt_3.png)
![](../../../Attachments/dt_4.png)

**MSGID 4769:**

![](../../../Attachments/dt_5.png)
![](../../../Attachments/dt_8.png)

–ó–∞–º–µ—Ç–∏–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏ –≤ –Ω–∏—Ö –Ω–∏—á–µ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–µ—Ç, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –∞–¥—Ä–µ—Å–∞ –Ω–µ–¥–æ–º–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω—ã.
–í—Å–ø–æ–º–Ω–∏–º, —á—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è TGS —è–≤–ª—è–µ—Ç—Å—è MSGID 4624 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É). 

**MSGID 4624:**

![](../../../Attachments/dt_6.png)
![](../../../Attachments/dt_7.png)

–ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ, –∫–∞—Ä—Ç–∏–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–µ–¥–µ–ª—å–Ω–æ —è—Å–Ω–∞: SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (-1143) –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–±—ã—Ç–∏–∏ –≤—Ö–æ–¥–∞ (-500) –∏, –∫–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, –ò–î –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø–æ–≤—ã—à–µ–Ω–∏–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.
## Sapphire Ticket
### –≠—Ç–∞–ø –ø–æ–ª—É—á–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞
Sapphire Ticket –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ 4768 (–ó–∞–ø—Ä–æ—Å TGT), –Ω–æ —Ç–∞–∫–∂–µ –∏ —Å–æ–±—ã—Ç–∏–µ 4769 (–ó–∞–ø—Ä–æ—Å TGS).

**MSGID 4768:**

![](../../../Attachments/sst_4.png)

**MSGID 4769:**

![](../../../Attachments/sst_5.png)

–ü—Ä–∏ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ñ–∞–∫—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–ª—É–∂–±–µ, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–≤–Ω–∞ —Å—É–±—ä–µ–∫—Ç—É –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –∑–∞–ø—Ä–æ—Å—É –±–∏–ª–µ—Ç–∞ (–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–∞–º —Å–µ–±—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–ª—É–∂–±—ã). –¢–∞–∫–∞—è –∞–Ω–æ–º–∞–ª–∏—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è S4U2Self
### –≠—Ç–∞–ø —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –±–∏–ª–µ—Ç–∞
–ü—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –∞—Ç–∞–∫–∏ Pass-The-Ticket, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è 2 —Å–æ–±—ã—Ç–∏—è: 4769 (–ó–∞–ø—Ä–æ—Å TGS) –∏ 4624 (–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É):

**MSGID 4769:**

![](../../../Attachments/sst_11.png)

–í —Ü–µ–ª–æ–º, –≤ —ç—Ç–æ–º —Å–æ–±—ã—Ç–∏–∏ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ –Ω–µ—Ç. –û–¥–Ω–∞–∫–æ, –∫–ª—é—á–µ–≤—ã–º –º–æ–º–µ–Ω—Ç–æ–º —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–æ—Å–∞ TGT (MSGID 4768) –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–ª—É–∂–±–µ, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –£–ó —Ö–æ—Å—Ç–∞.

**MSGID 4624:**

![](../../../Attachments/sst_12.png)

–ó–¥–µ—Å—å —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å —Å—É–±—ä–µ–∫—Ç–∞ –∏, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º,   –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ –¥–ª—è –£–ó —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.

–ü–æ —Å–≤–æ–µ–π —Å—É—Ç–∏, –∫–æ–Ω–µ—á–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–∞–Ω–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å Golden Ticket.

### ¬†**–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: Diamond vs Sapphire**

| **–ö—Ä–∏—Ç–µ—Ä–∏–π**        | Diamond Ticket üé´      | Sapphire Ticket üíé    |
| ------------------- | ---------------------- | --------------------- |
| –ù—É–∂–µ–Ω –ª–∏ TGT?       | ‚úÖ                      | ‚úÖ                     |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –≤ 4768  | ‚ùå                      | ‚ùå                     |
| –†–∏—Å–∫ –¥–ª—è –∞—Ç–∞–∫—É—é—â–µ–≥–æ | –í—ã—Å–æ–∫–∏–π (SID mismatch) | –ù–∏–∑–∫–∏–π (—Ä–µ–∞–ª—å–Ω—ã–π PAC) |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è Blue  | –°—Ä–µ–¥–Ω—è—è                | –í—ã—Å–æ–∫–∞—è               |
# –î–µ—Ç–µ–∫—Ç–æ—Ä—ã –∑–∞ 5 –º–∏–Ω—É—Ç
–ü–æ–∏—Å–∫–∞–≤ –Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ä–∞—Ö –Ω–µ–æ–±—ä—è—Ç–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –≥–æ—Ç–æ–≤—ã–µ —Å–ø–æ—Å–æ–±—ã –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Ç–∞–∫, —è –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–µ–ª, –ø–æ–≥—Ä—É—Å—Ç–∏–ª –∏ –ø–æ—à–µ–ª –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ 2 sigma-–ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫.

[–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø—Ä–∞–≤–∏–ª–∞—Ö sigma](https://github.com/SigmaHQ/sigma)
## Diamond Ticket

```yaml
title: Detecting Potential Diamond Ticket Attack
id: ddbd411e-3e34-4121-a6c2-5873db4ca696
status: experimental
description: –ü—Ä–∞–≤–∏–ª–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ Diamond Ticket
references: 
  - https://github.com/artroneee/Cyber-Security-Collection/blob/main/Cyber%20Security%20Collection/Windows/Active%20Directory/Diamond%20%26%20Sapphire%20Tickets.md
tags:
  - attack.t1558
author: artrone
date: 2025-03-12
logsource:
  product: windows
  service: security
detection:
  event_1:
    EventID: 4624
  artefacts_1:
    SubjectUserSid: 'S-1-0-0'
    TargetUserSid|endswith: 
      - '-500'
  event_2:
    EventID: 4769
  artefacts_2:
    ServiceName|endswith: '$'
    TicketEncryptionType: '0x12'
  filter:
    - TargetUserID: 'S-1-5-18'
    - TargetUserName|endswith: '$'
condition: ((event_1 and artefacts_1) or (event_2 and artefacts_2)) and not filter
fields:
  - TargetUserSid
  - ServiceName
falsepositives:
  - legitimate windows processes (need white/black lists)
level: high
```
		 
–ü—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º:
1. –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ 4624: –ï—Å–ª–∏ —Å—É–±—ä–µ–∫—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–ª–∏—Ü–µ—Ç–≤–æ—Ä–µ–Ω–∏—è –≤—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á–µ–π SID –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ -500 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è impacket-ticketer).
2. –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ 4769: –ï—Å–ª–∏ –∏–º—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "$" (–£–ó —Ö–æ—Å—Ç–∞) –∏ —Ç–∏–ø —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è 0—Ö12.
3. –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –ï—Å–ª–∏ –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π/–£–ó-—Å–ª—É–∂–±—ã –ø—Ä–∏ SubjectUserSid = S-1-0-0.
## Sapphire Ticket
```yaml
title: Detecting Potential Sapphire Ticket Attack
id: 3d478918-0183-45b0-92e3-04222b79791b
status: experimental
description: –ü—Ä–∞–≤–∏–ª–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—Ç–∞–∫–∏ Sapphire Ticket
references: 
  - https://github.com/artroneee/Cyber-Security-Collection/blob/main/Cyber%20Security%20Collection/Windows/Active%20Directory/Diamond%20%26%20Sapphire%20Tickets.md
tags:
  - attack.t1558
author: artrone
date: 2025-03-12
logsource:
  product: windows
  service: security
detection:
  event:
    EventID: 4769
  artefacts:
    TargetUserName|re: '(?i)^(.*)@.*$'
    ServiceName: \\1    # –∑–∞—Ö–≤–∞—Ç–∏–º –≥—Ä—É–ø–ø—É —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
    TicketEncryptionType: '0x12'
condition: event and artefacts
fields:
  - ServiceName
  - TargetUserName
falsepositives:
  - pentest
level: high
```
–ü—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É:
* –ï—Å–ª–∏ –∏–º—è –£–ó —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º —Å–µ—Ä–≤–∏—Å–∞ –∏ —Ç–∏–ø —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è 0—Ö12, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–ª–µ—Ä—Ç.

